---
task_id: 002
title: "配置管理系统重构"
phase: 1
priority: high
estimated_effort: 2d
parallel: true
dependencies: ["001"]
assignee: "backend-engineer"
tags: ["config", "ai-integration", "yaml"]
---

# Task 002: 配置管理系统重构 ⚙️

## 概述
实现灵活的分层配置管理系统，支持AI LLMs API配置、命令行参数覆盖、环境变量集成，为VulnMiner v2提供工业级的配置管理能力。

## 背景与需求
当前配置系统需要升级以支持：
1. **AI LLMs集成**: OpenAI、Claude、Ollama等多提供商配置
2. **灵活的API配置**: 支持自定义base_url和API参数
3. **分层配置**: 默认值 < 配置文件 < 环境变量 < 命令行参数
4. **配置验证**: 类型检查、必填项验证、格式校验

## 技术架构

### 1. 配置层次结构
```
优先级（高到低）：
1. 命令行参数 (--ai-provider=openai)
2. 环境变量 (VULN_MINER_AI_PROVIDER=openai)
3. 用户配置文件 (~/.vulnminer/config.yml)
4. 项目配置文件 (config/user.yml)
5. 默认配置 (config/default.yml)
```

### 2. 配置文件结构
```yaml
# config/default.yml
system:
  debug: false
  max_concurrent_scans: 3
  timeout: 300
  scan_mode:
    loop_enabled: true
    file_import_enabled: true
    max_targets_per_session: 100

ai:
  enabled: true
  default_provider: "openai"
  fallback_order: ["openai", "claude", "ollama"]
  
  providers:
    openai:
      api_key: "${OPENAI_API_KEY}"
      base_url: "${OPENAI_BASE_URL:https://api.openai.com/v1}"
      model: "gpt-4"
      timeout: 30
      max_tokens: 4000
      temperature: 0.1
      
    claude:
      api_key: "${CLAUDE_API_KEY}"
      base_url: "${CLAUDE_BASE_URL:https://api.anthropic.com}"
      model: "claude-3-sonnet-20240229"
      timeout: 30
      max_tokens: 4000
      
    ollama:
      base_url: "${OLLAMA_BASE_URL:http://localhost:11434}"
      model: "${OLLAMA_MODEL:llama2}"
      timeout: 60

scanning:
  pipelines:
    quick:
      enabled_tools: ["nmap", "nuclei"]
      timeout: 300
    comprehensive:
      enabled_tools: ["nmap", "nuclei", "subfinder", "httpx", "gobuster"]
      timeout: 1800
      
  loop_mode:
    prompt_text: "目标 > "
    quit_commands: ["quit", "exit", "q"]
    file_commands: ["file", "import"]
    max_failures: 3
    
  file_import:
    supported_formats: [".txt", ".csv", ".json"]
    encoding: "utf-8"
    max_file_size: "10MB"
    max_targets: 1000

tools:
  nmap:
    enabled: true
    default_args: ["-sS", "-sV", "-O"]
    timing_template: 3
    max_ports: 1000
    
  nuclei:
    enabled: true
    templates_dir: "data/nuclei-templates"
    update_templates: true
    severity_filter: ["critical", "high", "medium"]
```

## 实施步骤

### Step 1: 配置基础框架 (0.5天)

#### 1.1 配置数据模型
```python
# vuln_scanner/core/config/models.py
from dataclasses import dataclass, field
from typing import Dict, List, Optional, Union
from enum import Enum

class AIProvider(Enum):
    OPENAI = "openai"
    CLAUDE = "claude"
    OLLAMA = "ollama"

@dataclass
class AIProviderConfig:
    """AI提供商配置"""
    api_key: Optional[str] = None
    base_url: str = ""
    model: str = ""
    timeout: int = 30
    max_tokens: int = 4000
    temperature: float = 0.1

@dataclass
class AIConfig:
    """AI集成配置"""
    enabled: bool = True
    default_provider: str = "openai"
    fallback_order: List[str] = field(default_factory=lambda: ["openai", "claude"])
    providers: Dict[str, AIProviderConfig] = field(default_factory=dict)

@dataclass
class ScanConfig:
    """扫描配置"""
    loop_enabled: bool = True
    file_import_enabled: bool = True
    max_targets_per_session: int = 100
    timeout: int = 300

@dataclass
class VulnMinerConfig:
    """VulnMiner主配置"""
    debug: bool = False
    max_concurrent_scans: int = 3
    ai: AIConfig = field(default_factory=AIConfig)
    scanning: ScanConfig = field(default_factory=ScanConfig)
```

#### 1.2 配置管理器核心
```python
# vuln_scanner/core/config/manager.py
import os
import yaml
from pathlib import Path
from typing import Dict, Any, List, Optional
from .models import VulnMinerConfig, AIConfig, AIProviderConfig

class ConfigManager:
    """配置管理器 - 支持分层配置和环境变量替换"""
    
    def __init__(self, config_path: Optional[str] = None):
        self.config_path = config_path
        self.config = self._load_config()
        
    def _load_config(self) -> VulnMinerConfig:
        """加载分层配置"""
        # 1. 加载默认配置
        default_config = self._load_yaml_file(
            Path(__file__).parent.parent.parent / "config" / "default.yml"
        )
        
        # 2. 加载项目配置文件
        project_config = self._load_yaml_file(
            Path(__file__).parent.parent.parent / "config" / "user.yml"
        )
        
        # 3. 加载用户配置文件
        user_config_path = Path.home() / ".vulnminer" / "config.yml"
        user_config = self._load_yaml_file(user_config_path)
        
        # 4. 加载指定配置文件
        custom_config = {}
        if self.config_path:
            custom_config = self._load_yaml_file(Path(self.config_path))
        
        # 5. 合并配置（优先级：custom > user > project > default）
        merged_config = self._merge_configs([
            default_config,
            project_config, 
            user_config,
            custom_config
        ])
        
        # 6. 环境变量替换
        resolved_config = self._resolve_env_vars(merged_config)
        
        # 7. 转换为配置对象
        return self._dict_to_config(resolved_config)
```

### Step 2: 环境变量和模板支持 (0.5天)

#### 2.1 环境变量解析
```python
def _resolve_env_vars(self, config: Dict[str, Any]) -> Dict[str, Any]:
    """解析配置中的环境变量"""
    def resolve_value(value):
        if isinstance(value, str) and value.startswith("${") and value.endswith("}"):
            # 支持默认值：${VAR:default_value}
            var_expr = value[2:-1]  # 移除 ${ 和 }
            
            if ":" in var_expr:
                var_name, default_value = var_expr.split(":", 1)
                return os.getenv(var_name.strip(), default_value)
            else:
                return os.getenv(var_expr.strip(), "")
        elif isinstance(value, dict):
            return {k: resolve_value(v) for k, v in value.items()}
        elif isinstance(value, list):
            return [resolve_value(item) for item in value]
        else:
            return value
    
    return resolve_value(config)
```

#### 2.2 配置验证器
```python
# vuln_scanner/core/config/validator.py
from typing import List, Any, Dict

class ConfigValidator:
    """配置验证器 - 验证配置的完整性和正确性"""
    
    def validate(self, config: VulnMinerConfig) -> List[str]:
        """验证配置并返回错误列表"""
        errors = []
        
        # 验证AI配置
        if config.ai.enabled:
            errors.extend(self._validate_ai_config(config.ai))
        
        # 验证扫描配置
        errors.extend(self._validate_scan_config(config.scanning))
        
        # 验证系统配置
        errors.extend(self._validate_system_config(config))
        
        return errors
    
    def _validate_ai_config(self, ai_config: AIConfig) -> List[str]:
        """验证AI配置"""
        errors = []
        
        # 检查默认提供商是否在支持列表中
        if ai_config.default_provider not in ai_config.providers:
            errors.append(f"默认AI提供商 '{ai_config.default_provider}' 未在providers中定义")
        
        # 验证每个提供商配置
        for provider_name, provider_config in ai_config.providers.items():
            if provider_name in ["openai", "claude"] and not provider_config.api_key:
                errors.append(f"AI提供商 '{provider_name}' 缺少API密钥")
            
            if not provider_config.base_url:
                errors.append(f"AI提供商 '{provider_name}' 缺少base_url")
                
        return errors
```

### Step 3: 命令行集成 (0.5天)

#### 3.1 命令行参数扩展
```python
# vuln_scanner/start.py (更新现有文件)
def create_parser():
    parser = argparse.ArgumentParser(description="VulnMiner v2 - 工业级漏洞扫描系统")
    
    # 配置相关参数
    parser.add_argument("--config", "-c", help="配置文件路径")
    parser.add_argument("--ai-provider", choices=["openai", "claude", "ollama"], 
                       help="AI提供商选择")
    parser.add_argument("--ai-base-url", help="AI API基础URL")
    parser.add_argument("--ai-model", help="AI模型名称")
    parser.add_argument("--max-targets", type=int, help="最大目标数量")
    
    # 扫描模式参数
    scan_parser = subparsers.add_parser("scan")
    scan_parser.add_argument("--loop", action="store_true", help="启用循环扫描模式")
    scan_parser.add_argument("--file-import", help="从文件导入目标")
    
    return parser

def apply_cli_overrides(config: VulnMinerConfig, args: argparse.Namespace):
    """应用命令行参数覆盖"""
    if args.ai_provider:
        config.ai.default_provider = args.ai_provider
    
    if args.ai_base_url and args.ai_provider:
        if args.ai_provider in config.ai.providers:
            config.ai.providers[args.ai_provider].base_url = args.ai_base_url
    
    if args.max_targets:
        config.scanning.max_targets_per_session = args.max_targets
```

### Step 4: 配置工具和测试 (0.5天)

#### 4.1 配置管理CLI工具
```python
# vuln_scanner/tools/config_tool.py
import click
from ..core.config import ConfigManager

@click.group()
def config():
    """配置管理工具"""
    pass

@config.command()
def validate():
    """验证当前配置"""
    config_manager = ConfigManager()
    errors = config_manager.validate()
    
    if errors:
        click.echo("❌ 配置验证失败:")
        for error in errors:
            click.echo(f"  - {error}")
        return 1
    else:
        click.echo("✅ 配置验证通过")
        return 0

@config.command()
@click.option("--provider", help="AI提供商名称")
def test_ai(provider):
    """测试AI提供商连接"""
    config_manager = ConfigManager()
    # 实现AI连接测试逻辑
    pass

@config.command()
def show():
    """显示当前配置"""
    config_manager = ConfigManager()
    # 实现配置显示逻辑（隐敏感信息）
    pass
```

## 验收标准

### 功能性验收
- [ ] **分层配置**: 支持5层配置优先级
- [ ] **环境变量**: 支持 `${VAR:default}` 语法
- [ ] **AI配置**: 支持多AI提供商配置
- [ ] **命令行覆盖**: 命令行参数能覆盖配置文件
- [ ] **配置验证**: 能检测配置错误并给出明确提示

### API验收
```python
# 配置管理器API测试
config_manager = ConfigManager()

# 获取AI配置
ai_config = config_manager.get_ai_config()
assert ai_config.enabled == True

# 获取特定提供商配置
openai_config = config_manager.get_ai_provider_config("openai")
assert openai_config.base_url is not None

# 配置验证
errors = config_manager.validate()
assert len(errors) == 0
```

### 命令行验收
```bash
# 配置验证
python start.py --validate-config

# AI提供商测试
python start.py --ai-provider=openai --ai-base-url=https://api.openai.com/v1

# 配置显示
python start.py config show

# 配置测试
python start.py config test-ai --provider=openai
```

## 交付物

### 代码交付物
- [ ] ConfigManager类及相关模型
- [ ] 配置验证器和错误处理
- [ ] 环境变量解析器
- [ ] 命令行参数集成
- [ ] 配置管理CLI工具

### 配置文件交付物
- [ ] 完整的default.yml模板
- [ ] AI提供商配置示例
- [ ] 环境变量配置文档
- [ ] 用户配置文件模板

### 测试交付物
- [ ] 配置管理单元测试
- [ ] 环境变量解析测试
- [ ] 配置验证测试
- [ ] 命令行集成测试

## 风险与缓解

### 中风险项
1. **配置复杂性**: 多层配置可能导致调试困难
   - **缓解**: 提供配置追踪和调试工具
   - **监控**: 实现配置源追踪功能

2. **环境变量安全**: API密钥等敏感信息暴露风险
   - **缓解**: 实现配置加密和安全存储
   - **最佳实践**: 提供安全配置指南

---
**任务负责人**: Backend Engineer  
**审核人**: Security Engineer  
**依赖任务**: Task 001 (代码目录重构)  
**并行任务**: Task 003 (基础测试框架)  
**预计工作量**: 2天