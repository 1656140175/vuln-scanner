---
name: 报告生成系统
status: open
created: 2025-09-13T10:46:04Z
updated: 2025-09-13T10:46:04Z
github: [Will be updated when synced to GitHub]
depends_on: [004, 005]
parallel: false
conflicts_with: []
---

# Task 006: 报告生成系统

## 概述
构建comprehensive的漏洞扫描报告生成系统，支持多种格式输出、自定义模板、风险评估和合规性报告。系统需要整合五阶段扫描结果和进度管理数据，生成专业级安全评估报告。

## 技术要求

### 1. 报告数据模型

#### 核心报告结构
```python
class VulnerabilityReport:
    scan_id: str
    target_info: TargetInfo
    scan_metadata: ScanMetadata
    executive_summary: ExecutiveSummary
    technical_findings: List[TechnicalFinding]
    risk_assessment: RiskAssessment
    remediation_plan: RemediationPlan
    appendices: Dict[str, Any]
    compliance_mapping: ComplianceMapping
    
class TargetInfo:
    primary_target: str
    scope: List[str]
    exclusions: List[str]
    target_type: TargetType  # web_app, network, api, mobile
    business_context: str
    criticality_level: CriticalityLevel

class ScanMetadata:
    scan_start_time: datetime
    scan_end_time: datetime
    total_duration: timedelta
    scanner_version: str
    scan_configuration: Dict[str, Any]
    coverage_metrics: CoverageMetrics
    tool_versions: Dict[str, str]
    
class TechnicalFinding:
    finding_id: str
    title: str
    description: str
    severity: SeverityLevel
    confidence: ConfidenceLevel
    cvss_score: Optional[float]
    cve_references: List[str]
    affected_components: List[Component]
    proof_of_concept: Optional[ProofOfConcept]
    remediation: Remediation
    references: List[Reference]
    discovery_phase: ScanPhase
    verification_status: VerificationStatus
```

### 2. 报告生成引擎

#### 主报告生成器
```python
class ReportGenerator:
    def __init__(self, template_manager: TemplateManager, 
                 formatter_registry: FormatterRegistry):
        self.template_manager = template_manager
        self.formatters = formatter_registry
        self.risk_calculator = RiskCalculator()
        self.compliance_mapper = ComplianceMapper()
    
    async def generate_report(self, scan_results: ScanResults, 
                            config: ReportConfig) -> GeneratedReport:
        """生成完整的漏洞报告"""
        # 数据预处理和分析
        processed_data = await self._process_scan_data(scan_results)
        
        # 风险评估
        risk_assessment = await self.risk_calculator.calculate_risks(processed_data)
        
        # 合规性映射
        compliance_mapping = await self.compliance_mapper.map_findings(processed_data)
        
        # 生成报告结构
        report = await self._build_report_structure(processed_data, risk_assessment, compliance_mapping)
        
        # 应用模板和格式化
        formatted_report = await self._format_report(report, config)
        
        return formatted_report
```

#### 多格式支持
```python
class FormatterRegistry:
    def __init__(self):
        self.formatters = {
            ReportFormat.PDF: PDFFormatter(),
            ReportFormat.HTML: HTMLFormatter(), 
            ReportFormat.DOCX: DOCXFormatter(),
            ReportFormat.JSON: JSONFormatter(),
            ReportFormat.XML: XMLFormatter(),
            ReportFormat.SARIF: SARIFFormatter(),
            ReportFormat.CSV: CSVFormatter()
        }
    
    def get_formatter(self, format_type: ReportFormat) -> BaseFormatter:
        return self.formatters.get(format_type)

class BaseFormatter:
    async def format_report(self, report: VulnerabilityReport, 
                          config: FormatConfig) -> bytes:
        """格式化报告为指定格式"""
        pass

class PDFFormatter(BaseFormatter):
    def __init__(self):
        self.pdf_engine = WeasyPrint()  # 或 ReportLab
        
    async def format_report(self, report: VulnerabilityReport, 
                          config: PDFConfig) -> bytes:
        # HTML -> PDF 转换
        html_content = await self._render_html_template(report, config)
        pdf_bytes = self.pdf_engine.convert(html_content, config.pdf_options)
        return pdf_bytes
```

### 3. 模板系统

#### 模板管理器
```python
class TemplateManager:
    def __init__(self, template_path: str):
        self.template_path = Path(template_path)
        self.jinja_env = Environment(
            loader=FileSystemLoader(self.template_path),
            autoescape=select_autoescape(['html', 'xml'])
        )
        self.custom_filters = {
            'severity_color': self._severity_color_filter,
            'cvss_rating': self._cvss_rating_filter,
            'format_timestamp': self._timestamp_filter
        }
    
    async def render_template(self, template_name: str, 
                            context: Dict[str, Any]) -> str:
        """渲染模板"""
        template = self.jinja_env.get_template(template_name)
        return template.render(**context)
    
    async def register_custom_template(self, name: str, content: str) -> None:
        """注册自定义模板"""
        pass

class TemplateType(Enum):
    EXECUTIVE_SUMMARY = "executive_summary.html"
    TECHNICAL_DETAILS = "technical_details.html"
    RISK_MATRIX = "risk_matrix.html"
    REMEDIATION_PLAN = "remediation_plan.html"
    APPENDIX = "appendix.html"
```

#### 预定义模板
```html
<!-- templates/executive_summary.html -->
<div class="executive-summary">
    <h2>Executive Summary</h2>
    <div class="summary-stats">
        <div class="stat critical">
            <span class="count">{{ findings.critical|length }}</span>
            <span class="label">Critical</span>
        </div>
        <div class="stat high">
            <span class="count">{{ findings.high|length }}</span>
            <span class="label">High</span>
        </div>
        <!-- 更多统计 -->
    </div>
    
    <div class="key-findings">
        <h3>Key Findings</h3>
        {% for finding in findings.top_critical %}
        <div class="key-finding">
            <h4>{{ finding.title }}</h4>
            <p>{{ finding.executive_summary }}</p>
            <div class="risk-rating">Risk: {{ finding.severity|severity_color }}</div>
        </div>
        {% endfor %}
    </div>
</div>
```

### 4. 风险评估与分析

#### 风险计算器
```python
class RiskCalculator:
    def __init__(self):
        self.severity_weights = {
            SeverityLevel.CRITICAL: 1.0,
            SeverityLevel.HIGH: 0.8,
            SeverityLevel.MEDIUM: 0.5,
            SeverityLevel.LOW: 0.2,
            SeverityLevel.INFO: 0.0
        }
        self.confidence_modifiers = {
            ConfidenceLevel.CONFIRMED: 1.0,
            ConfidenceLevel.FIRM: 0.9,
            ConfidenceLevel.TENTATIVE: 0.7,
            ConfidenceLevel.POSSIBLE: 0.5
        }
    
    async def calculate_overall_risk(self, findings: List[TechnicalFinding]) -> RiskScore:
        """计算整体风险评分"""
        total_risk = 0.0
        critical_path_risk = 0.0
        
        for finding in findings:
            base_risk = self.severity_weights[finding.severity]
            confidence_modifier = self.confidence_modifiers[finding.confidence]
            business_impact = await self._assess_business_impact(finding)
            
            finding_risk = base_risk * confidence_modifier * business_impact
            total_risk += finding_risk
            
            if finding.affects_critical_path:
                critical_path_risk += finding_risk
        
        return RiskScore(
            overall_score=min(total_risk, 10.0),
            critical_path_score=critical_path_risk,
            risk_level=self._determine_risk_level(total_risk),
            contributing_factors=self._analyze_risk_factors(findings)
        )
    
    async def generate_risk_matrix(self, findings: List[TechnicalFinding]) -> RiskMatrix:
        """生成风险矩阵"""
        matrix = RiskMatrix()
        
        for finding in findings:
            impact = await self._assess_impact_level(finding)
            likelihood = await self._assess_likelihood(finding)
            matrix.add_finding(finding, impact, likelihood)
        
        return matrix
```

#### 趋势分析
```python
class TrendAnalyzer:
    async def analyze_vulnerability_trends(self, historical_reports: List[VulnerabilityReport]) -> TrendAnalysis:
        """分析漏洞趋势"""
        return TrendAnalysis(
            severity_trends=self._analyze_severity_trends(historical_reports),
            category_trends=self._analyze_category_trends(historical_reports),
            remediation_effectiveness=self._analyze_remediation_trends(historical_reports),
            new_vulnerability_patterns=self._identify_new_patterns(historical_reports)
        )
```

### 5. 合规性映射

#### 合规框架支持
```python
class ComplianceMapper:
    def __init__(self):
        self.frameworks = {
            ComplianceFramework.OWASP_TOP10: OWASPTop10Mapper(),
            ComplianceFramework.CWE: CWEMapper(),
            ComplianceFramework.NIST: NISTMapper(),
            ComplianceFramework.ISO27001: ISO27001Mapper(),
            ComplianceFramework.PCI_DSS: PCIDSSMapper(),
            ComplianceFramework.GDPR: GDPRMapper()
        }
    
    async def map_findings_to_compliance(self, findings: List[TechnicalFinding], 
                                       frameworks: List[ComplianceFramework]) -> ComplianceMapping:
        """将发现的问题映射到合规框架"""
        mapping = ComplianceMapping()
        
        for framework in frameworks:
            mapper = self.frameworks[framework]
            framework_mapping = await mapper.map_findings(findings)
            mapping.add_framework_mapping(framework, framework_mapping)
        
        return mapping

class OWASPTop10Mapper:
    def __init__(self):
        self.owasp_categories = {
            "A01_2021": "Broken Access Control",
            "A02_2021": "Cryptographic Failures", 
            "A03_2021": "Injection",
            # ... 完整的OWASP Top 10
        }
    
    async def map_findings(self, findings: List[TechnicalFinding]) -> FrameworkMapping:
        """映射到OWASP Top 10"""
        mapping = FrameworkMapping(framework=ComplianceFramework.OWASP_TOP10)
        
        for finding in findings:
            owasp_category = await self._categorize_finding(finding)
            if owasp_category:
                mapping.add_mapping(finding.finding_id, owasp_category)
        
        return mapping
```

### 6. 自动化报告增强

#### 智能摘要生成
```python
class IntelligentSummarizer:
    def __init__(self, llm_client: Optional[LLMClient] = None):
        self.llm_client = llm_client
        self.template_summarizer = TemplateSummarizer()
    
    async def generate_executive_summary(self, findings: List[TechnicalFinding], 
                                       target_info: TargetInfo) -> ExecutiveSummary:
        """生成执行摘要"""
        if self.llm_client:
            return await self._generate_ai_summary(findings, target_info)
        else:
            return await self.template_summarizer.generate_summary(findings, target_info)
    
    async def generate_business_impact_analysis(self, findings: List[TechnicalFinding]) -> BusinessImpactAnalysis:
        """生成业务影响分析"""
        pass

class RecommendationEngine:
    async def generate_remediation_recommendations(self, findings: List[TechnicalFinding]) -> List[Recommendation]:
        """生成修复建议"""
        recommendations = []
        
        # 按严重性和业务影响排序
        prioritized_findings = await self._prioritize_findings(findings)
        
        for finding in prioritized_findings:
            recommendation = await self._generate_finding_recommendation(finding)
            recommendations.append(recommendation)
        
        # 生成整体安全改进建议
        strategic_recommendations = await self._generate_strategic_recommendations(findings)
        recommendations.extend(strategic_recommendations)
        
        return recommendations
```

### 7. 报告配置与自定义

#### 配置系统
```python
class ReportConfig:
    output_format: List[ReportFormat]
    template_name: str
    include_sections: List[ReportSection]
    compliance_frameworks: List[ComplianceFramework]
    branding: BrandingConfig
    classification: ClassificationLevel
    custom_fields: Dict[str, Any]
    
class BrandingConfig:
    company_name: str
    logo_path: Optional[str]
    color_scheme: ColorScheme
    footer_text: str
    contact_information: ContactInfo

class ReportSection(Enum):
    EXECUTIVE_SUMMARY = "executive_summary"
    TECHNICAL_FINDINGS = "technical_findings" 
    RISK_ASSESSMENT = "risk_assessment"
    REMEDIATION_PLAN = "remediation_plan"
    COMPLIANCE_MAPPING = "compliance_mapping"
    APPENDICES = "appendices"
    METHODOLOGY = "methodology"
    LIMITATIONS = "limitations"
```

## 实现细节

### 8. 性能优化

#### 大规模报告生成
```python
class PerformanceOptimizer:
    async def optimize_large_reports(self, report_data: VulnerabilityReport) -> VulnerabilityReport:
        """优化大型报告的生成性能"""
        # 分页处理大量发现
        if len(report_data.technical_findings) > 1000:
            report_data = await self._paginate_findings(report_data)
        
        # 异步生成图表和统计
        charts_task = asyncio.create_task(self._generate_charts(report_data))
        stats_task = asyncio.create_task(self._calculate_statistics(report_data))
        
        await asyncio.gather(charts_task, stats_task)
        
        return report_data
```

### 9. API 和 CLI 接口

#### REST API
```python
class ReportAPI:
    @app.post("/api/v1/reports/generate")
    async def generate_report(self, request: GenerateReportRequest) -> GenerateReportResponse:
        """生成报告"""
        
    @app.get("/api/v1/reports/{report_id}/download")
    async def download_report(self, report_id: str, format: ReportFormat) -> StreamingResponse:
        """下载报告"""
        
    @app.get("/api/v1/reports/{report_id}/preview")
    async def preview_report(self, report_id: str) -> PreviewResponse:
        """预览报告"""
```

#### CLI 命令
```bash
# 生成报告
vuln-miner report generate --scan-id <id> --format pdf,html --template executive
vuln-miner report generate --config report-config.yaml

# 报告管理
vuln-miner report list
vuln-miner report show <report-id>
vuln-miner report export <report-id> --format json

# 模板管理
vuln-miner template list
vuln-miner template create --name custom --base executive
vuln-miner template validate template.yaml
```

## 文件结构
```
src/reporting/
├── __init__.py
├── models.py              # 报告数据模型
├── generator.py           # 主报告生成器
├── formatters/
│   ├── __init__.py
│   ├── base.py           # 基础格式化器
│   ├── pdf.py            # PDF格式化器
│   ├── html.py           # HTML格式化器
│   ├── docx.py           # Word格式化器
│   ├── json.py           # JSON格式化器
│   └── sarif.py          # SARIF格式化器
├── templates/
│   ├── base/             # 基础模板
│   ├── executive/        # 执行级模板
│   ├── technical/        # 技术详细模板
│   └── compliance/       # 合规性模板
├── risk/
│   ├── __init__.py
│   ├── calculator.py     # 风险计算
│   ├── analyzer.py       # 趋势分析
│   └── matrix.py         # 风险矩阵
├── compliance/
│   ├── __init__.py
│   ├── mapper.py         # 合规映射器
│   ├── owasp.py         # OWASP映射
│   ├── cwe.py           # CWE映射
│   └── frameworks.py    # 其他框架
├── intelligence/
│   ├── __init__.py
│   ├── summarizer.py     # 智能摘要
│   └── recommendations.py # 建议引擎
└── api.py                # API接口
```

## 验收标准
1. 支持至少5种主要报告格式（PDF, HTML, DOCX, JSON, SARIF）
2. 模板系统完整，支持自定义模板
3. 风险评估准确，包含定量和定性分析
4. 合规性映射覆盖主要安全框架
5. 报告生成时间在可接受范围内（<2分钟/1000个发现）
6. 支持大规模报告生成（>5000个发现）
7. 智能摘要和建议功能正常
8. CLI和API接口完整
9. 报告质量专业，适合向管理层汇报
10. 完整的单元测试覆盖

## 预估工作量
**3 天**

## 风险点
1. 大规模报告的性能问题
2. PDF生成的复杂性和样式一致性
3. 合规性映射的准确性
4. 模板系统的灵活性与复杂性平衡

## 完成标志
- 所有报告格式都能正确生成
- 风险评估和合规性映射功能完整
- 模板系统支持自定义和扩展
- 性能满足大规模使用需求
- 文档完整，用户可以独立使用