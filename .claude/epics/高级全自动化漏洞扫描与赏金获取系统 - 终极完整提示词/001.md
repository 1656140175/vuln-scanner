---
name: 基础框架搭建
status: open
created: 2025-09-13T10:46:04Z
updated: 2025-09-13T10:46:04Z
github: [Will be updated when synced to GitHub]
depends_on: []
parallel: true
conflicts_with: []
---

# Task 001: 基础框架搭建

## 概述
搭建漏洞扫描系统的核心基础架构，包括项目结构、配置管理、日志系统和基本的安全框架。

## 技术实现要求

### 1. 项目结构设计
```
vuln_miner/
├── src/
│   ├── core/                 # 核心框架
│   │   ├── config/          # 配置管理
│   │   ├── logger/          # 日志系统
│   │   ├── security/        # 安全控制
│   │   └── exceptions/      # 异常处理
│   ├── scanners/            # 扫描器模块
│   ├── tools/               # 工具集成
│   ├── reports/             # 报告生成
│   └── utils/               # 工具函数
├── config/                  # 配置文件
├── data/                    # 数据存储
├── logs/                    # 日志文件
├── tests/                   # 测试文件
└── docs/                    # 文档
```

### 2. 配置管理系统
- **多环境配置**: 开发、测试、生产环境
- **敏感信息保护**: API密钥、数据库密码等加密存储
- **动态配置加载**: 支持配置文件热更新
- **配置验证**: 启动时验证配置完整性

#### 核心配置文件结构
```yaml
# config/default.yml
system:
  version: "1.0.0"
  environment: "development"
  debug: true
  max_concurrent_scans: 10
  timeout: 300

security:
  authorization:
    enabled: true
    whitelist_only: true
    allowed_targets: []
  rate_limiting:
    enabled: true
    requests_per_minute: 60
  ssl_verification: true

logging:
  level: "INFO"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  file_rotation: true
  max_file_size: "10MB"
  backup_count: 5

database:
  type: "sqlite"  # sqlite, postgresql, mysql
  path: "data/vulns.db"
  pool_size: 10
  timeout: 30

tools:
  nmap:
    path: "/usr/bin/nmap"
    default_args: ["-sS", "-O", "-sV"]
  nuclei:
    path: "/usr/bin/nuclei"
    templates_dir: "data/nuclei-templates"
  custom_scripts_dir: "scripts/"
```

### 3. 日志系统
- **结构化日志**: JSON格式，便于分析
- **日志分级**: DEBUG, INFO, WARNING, ERROR, CRITICAL
- **文件轮转**: 按大小和时间自动轮转
- **安全审计**: 记录所有扫描活动和用户操作

#### 日志实现
```python
import logging
import logging.handlers
import json
from datetime import datetime
from typing import Dict, Any

class SecurityAuditLogger:
    def __init__(self, config: Dict[str, Any]):
        self.logger = logging.getLogger('vuln_miner.security')
        self.setup_handlers(config)
    
    def log_scan_start(self, target: str, scan_type: str, user: str = None):
        self.logger.info("SCAN_START", extra={
            'event_type': 'scan_start',
            'target': target,
            'scan_type': scan_type,
            'user': user,
            'timestamp': datetime.utcnow().isoformat()
        })
    
    def log_vulnerability_found(self, vuln_data: Dict[str, Any]):
        self.logger.warning("VULNERABILITY_DETECTED", extra={
            'event_type': 'vulnerability',
            'severity': vuln_data.get('severity'),
            'target': vuln_data.get('target'),
            'vuln_type': vuln_data.get('type'),
            'timestamp': datetime.utcnow().isoformat()
        })
```

### 4. 安全框架
- **访问控制**: 基于白名单的目标授权
- **权限管理**: 不同用户角色的权限分离
- **审计跟踪**: 完整的操作审计日志
- **安全边界**: 防止扫描未授权目标

#### 安全控制实现
```python
import ipaddress
from typing import List, Set
from urllib.parse import urlparse

class SecurityController:
    def __init__(self, config: Dict[str, Any]):
        self.whitelist = set(config.get('security', {}).get('allowed_targets', []))
        self.authorization_required = config.get('security', {}).get('authorization', {}).get('enabled', True)
    
    def validate_target(self, target: str) -> bool:
        """验证目标是否在授权范围内"""
        if not self.authorization_required:
            return True
            
        # 解析目标
        parsed = urlparse(target if '://' in target else f'http://{target}')
        hostname = parsed.hostname or target
        
        # 检查白名单
        for allowed in self.whitelist:
            if self._match_target(hostname, allowed):
                return True
        
        return False
    
    def _match_target(self, hostname: str, pattern: str) -> bool:
        """匹配目标模式"""
        try:
            # IP地址范围匹配
            if '/' in pattern:
                network = ipaddress.ip_network(pattern, strict=False)
                target_ip = ipaddress.ip_address(hostname)
                return target_ip in network
            
            # 域名匹配
            if pattern.startswith('*.'):
                return hostname.endswith(pattern[2:])
            
            return hostname == pattern
            
        except ValueError:
            # 域名匹配
            return hostname == pattern or hostname.endswith(f'.{pattern}')
```

### 5. 异常处理系统
- **自定义异常**: 针对不同错误类型的专用异常
- **错误恢复**: 自动重试和降级策略
- **用户友好**: 清晰的错误信息和建议

```python
class VulnMinerException(Exception):
    """基础异常类"""
    pass

class UnauthorizedTargetException(VulnMinerException):
    """未授权目标异常"""
    def __init__(self, target: str):
        self.target = target
        super().__init__(f"Target '{target}' is not in the authorized whitelist")

class ToolNotFoundException(VulnMinerException):
    """工具未找到异常"""
    def __init__(self, tool_name: str):
        self.tool_name = tool_name
        super().__init__(f"Security tool '{tool_name}' not found or not executable")

class ScanTimeoutException(VulnMinerException):
    """扫描超时异常"""
    def __init__(self, timeout: int):
        self.timeout = timeout
        super().__init__(f"Scan operation timed out after {timeout} seconds")
```

### 6. 核心管理器
```python
from typing import Dict, Any, Optional
import yaml
import os

class VulnMinerCore:
    def __init__(self, config_path: str = None):
        self.config = self._load_config(config_path)
        self.logger = SecurityAuditLogger(self.config)
        self.security = SecurityController(self.config)
        
    def _load_config(self, config_path: str = None) -> Dict[str, Any]:
        """加载配置文件"""
        default_path = "config/default.yml"
        env_path = f"config/{os.getenv('VULN_MINER_ENV', 'development')}.yml"
        
        config = {}
        
        # 加载默认配置
        if os.path.exists(default_path):
            with open(default_path, 'r', encoding='utf-8') as f:
                config = yaml.safe_load(f)
        
        # 加载环境特定配置
        if os.path.exists(env_path):
            with open(env_path, 'r', encoding='utf-8') as f:
                env_config = yaml.safe_load(f)
                config.update(env_config)
        
        # 加载用户指定配置
        if config_path and os.path.exists(config_path):
            with open(config_path, 'r', encoding='utf-8') as f:
                user_config = yaml.safe_load(f)
                config.update(user_config)
        
        return config
    
    def validate_environment(self) -> bool:
        """验证运行环境"""
        required_tools = ['nmap', 'nuclei']
        missing_tools = []
        
        for tool in required_tools:
            tool_path = self.config.get('tools', {}).get(tool, {}).get('path')
            if not tool_path or not os.path.isfile(tool_path):
                missing_tools.append(tool)
        
        if missing_tools:
            self.logger.logger.error(f"Missing required tools: {missing_tools}")
            return False
        
        return True
```

## 实施计划

### 阶段1: 基础结构 (0.5天)
- 创建项目目录结构
- 设置基本的配置文件模板
- 实现配置加载器

### 阶段2: 日志系统 (0.5天)
- 实现结构化日志记录
- 配置日志轮转和格式化
- 添加安全审计功能

### 阶段3: 安全框架 (1天)
- 实现访问控制机制
- 添加目标验证功能
- 创建安全边界检查

### 阶段4: 异常处理 (0.5天)
- 定义自定义异常类
- 实现错误恢复机制
- 添加用户友好的错误消息

### 阶段5: 集成测试 (0.5天)
- 单元测试覆盖
- 集成测试验证
- 性能基准测试

## 验收标准

1. **配置系统**:
   - 支持多环境配置
   - 配置验证通过
   - 敏感信息正确加密

2. **日志系统**:
   - 结构化日志正常记录
   - 文件轮转正常工作
   - 安全审计事件完整

3. **安全控制**:
   - 白名单验证生效
   - 未授权访问被阻止
   - 审计日志完整记录

4. **异常处理**:
   - 所有异常类型正确处理
   - 错误信息清晰明了
   - 系统稳定运行

5. **测试覆盖**:
   - 单元测试覆盖率 > 90%
   - 所有核心功能经过测试
   - 边界条件处理正确

## 风险控制

1. **安全风险**: 严格的白名单控制，防止扫描未授权目标
2. **性能风险**: 合理的并发控制和资源限制
3. **稳定性风险**: 完善的异常处理和错误恢复机制

## 预计工期
**3天** (包含充分的测试和文档编写时间)

## 后续任务依赖
- Task 002 (工具生命周期管理) 依赖于本任务的配置系统和日志框架
- Task 003 (扫描引擎核心) 依赖于本任务的安全框架和异常处理系统