---
name: 进度管理系统
status: open
created: 2025-09-13T10:46:04Z
updated: 2025-09-13T10:46:04Z
github: [Will be updated when synced to GitHub]
depends_on: [003]
parallel: true
conflicts_with: []
---

# Task 005: 进度管理系统

## 概述
构建comprehensive的进度管理系统，支持实时进度跟踪、状态持久化、断点续传和多任务并发管理。系统需要与五阶段扫描系统深度集成。

## 技术要求

### 1. 进度状态模型
```python
class TaskStatus(Enum):
    PENDING = "pending"
    RUNNING = "running"
    PAUSED = "paused"
    COMPLETED = "completed"
    FAILED = "failed"
    CANCELLED = "cancelled"

class ProgressState:
    task_id: str
    scan_id: str
    current_phase: ScanPhase
    phase_progress: Dict[ScanPhase, PhaseProgress]
    overall_progress: float  # 0.0 - 1.0
    status: TaskStatus
    start_time: datetime
    estimated_completion: Optional[datetime]
    last_checkpoint: datetime
    metadata: Dict[str, Any]

class PhaseProgress:
    phase: ScanPhase
    status: TaskStatus
    progress_percentage: float
    current_step: str
    total_steps: int
    completed_steps: int
    start_time: datetime
    estimated_duration: Optional[timedelta]
    errors: List[ProgressError]
```

### 2. 进度跟踪核心组件

#### 进度管理器
```python
class ProgressManager:
    def __init__(self, storage: ProgressStorage, event_bus: EventBus):
        self.storage = storage
        self.event_bus = event_bus
        self.active_tasks: Dict[str, ProgressState] = {}
        self.checkpoint_interval = 30  # seconds
    
    async def create_task(self, scan_config: ScanConfig) -> str:
        """创建新的扫描任务并初始化进度状态"""
        
    async def update_progress(self, task_id: str, phase: ScanPhase, 
                            progress: float, current_step: str) -> None:
        """更新任务进度"""
        
    async def checkpoint(self, task_id: str) -> None:
        """创建进度检查点"""
        
    async def resume_task(self, task_id: str) -> ProgressState:
        """从检查点恢复任务"""
        
    async def pause_task(self, task_id: str) -> None:
        """暂停任务"""
        
    async def cancel_task(self, task_id: str) -> None:
        """取消任务"""
```

#### 进度存储层
```python
class ProgressStorage:
    """进度数据持久化接口"""
    
    async def save_progress(self, progress: ProgressState) -> None:
        """保存进度状态"""
        
    async def load_progress(self, task_id: str) -> Optional[ProgressState]:
        """加载进度状态"""
        
    async def list_active_tasks(self) -> List[str]:
        """获取活跃任务列表"""
        
    async def cleanup_completed_tasks(self, older_than: datetime) -> int:
        """清理已完成的旧任务"""

class SqliteProgressStorage(ProgressStorage):
    """SQLite实现的进度存储"""
    
class RedisProgressStorage(ProgressStorage):
    """Redis实现的进度存储（支持分布式）"""
```

### 3. 实时进度更新

#### 事件系统
```python
class ProgressEvent:
    task_id: str
    event_type: str
    timestamp: datetime
    data: Dict[str, Any]

class ProgressEventBus:
    def __init__(self):
        self.subscribers: Dict[str, List[Callable]] = {}
        self.websocket_manager: Optional[WebSocketManager] = None
    
    async def emit(self, event: ProgressEvent) -> None:
        """发送进度事件"""
        
    async def subscribe(self, event_type: str, callback: Callable) -> None:
        """订阅进度事件"""
        
    async def broadcast_to_websocket(self, task_id: str, data: Dict) -> None:
        """通过WebSocket广播进度更新"""
```

#### WebSocket支持
```python
class ProgressWebSocketHandler:
    async def connect(self, websocket: WebSocket, task_id: str) -> None:
        """建立WebSocket连接"""
        
    async def send_progress_update(self, task_id: str, progress: ProgressState) -> None:
        """发送进度更新"""
        
    async def disconnect(self, task_id: str) -> None:
        """断开连接"""
```

### 4. 断点续传机制

#### 检查点系统
```python
class CheckpointManager:
    def __init__(self, storage: ProgressStorage):
        self.storage = storage
        self.checkpoint_strategies = {
            ScanPhase.RECONNAISSANCE: ReconCheckpointStrategy(),
            ScanPhase.DISCOVERY: DiscoveryCheckpointStrategy(),
            # ... 其他阶段
        }
    
    async def create_checkpoint(self, task_id: str, phase_data: Dict) -> str:
        """创建检查点"""
        
    async def restore_from_checkpoint(self, task_id: str) -> Dict:
        """从检查点恢复"""
        
    async def list_checkpoints(self, task_id: str) -> List[CheckpointInfo]:
        """列出任务的所有检查点"""

class CheckpointStrategy:
    """检查点策略基类"""
    async def create_checkpoint(self, phase_data: Dict) -> Dict:
        """创建阶段特定的检查点数据"""
        
    async def restore_checkpoint(self, checkpoint_data: Dict) -> Dict:
        """恢复阶段特定的数据"""
```

### 5. 多任务并发管理

#### 任务队列系统
```python
class TaskQueue:
    def __init__(self, max_concurrent: int = 5):
        self.max_concurrent = max_concurrent
        self.running_tasks: Dict[str, asyncio.Task] = {}
        self.pending_queue: asyncio.Queue = asyncio.Queue()
        self.completed_tasks: List[str] = []
    
    async def submit_task(self, task_config: ScanConfig) -> str:
        """提交新任务到队列"""
        
    async def start_worker(self) -> None:
        """启动任务处理器"""
        
    async def get_queue_status(self) -> QueueStatus:
        """获取队列状态"""

class QueueStatus:
    running_count: int
    pending_count: int
    completed_count: int
    failed_count: int
    total_slots: int
    available_slots: int
```

### 6. 进度估算与预测

#### 时间估算器
```python
class ProgressEstimator:
    def __init__(self):
        self.historical_data: Dict[str, List[PhaseTimingData]] = {}
    
    async def estimate_phase_duration(self, phase: ScanPhase, 
                                    target_complexity: float) -> timedelta:
        """估算阶段执行时间"""
        
    async def estimate_total_duration(self, scan_config: ScanConfig) -> timedelta:
        """估算总执行时间"""
        
    async def update_historical_data(self, phase: ScanPhase, 
                                   timing_data: PhaseTimingData) -> None:
        """更新历史数据"""

class PhaseTimingData:
    phase: ScanPhase
    target_count: int
    complexity_score: float
    actual_duration: timedelta
    success_rate: float
    timestamp: datetime
```

## 实现细节

### 7. API接口设计

#### REST API
```python
# GET /api/v1/tasks/{task_id}/progress
# POST /api/v1/tasks/{task_id}/pause
# POST /api/v1/tasks/{task_id}/resume
# POST /api/v1/tasks/{task_id}/cancel
# GET /api/v1/tasks/active
# GET /api/v1/queue/status

class ProgressAPI:
    async def get_progress(self, task_id: str) -> ProgressResponse:
        """获取任务进度"""
        
    async def pause_task(self, task_id: str) -> StatusResponse:
        """暂停任务"""
        
    async def resume_task(self, task_id: str) -> StatusResponse:
        """恢复任务"""
```

#### CLI 命令
```bash
# 查看进度
vuln-miner progress show <task-id>
vuln-miner progress list --status running

# 任务控制
vuln-miner task pause <task-id>
vuln-miner task resume <task-id>
vuln-miner task cancel <task-id>

# 队列管理
vuln-miner queue status
vuln-miner queue clear --status failed
```

### 8. 监控与告警

#### 性能监控
```python
class ProgressMonitor:
    async def monitor_task_health(self, task_id: str) -> HealthStatus:
        """监控任务健康状态"""
        
    async def detect_stuck_tasks(self) -> List[str]:
        """检测卡住的任务"""
        
    async def monitor_resource_usage(self) -> ResourceMetrics:
        """监控资源使用情况"""

class HealthStatus:
    task_id: str
    is_healthy: bool
    last_update: datetime
    warnings: List[str]
    resource_usage: ResourceMetrics
```

## 文件结构
```
src/progress/
├── __init__.py
├── models.py              # 进度状态模型
├── manager.py             # 进度管理器
├── storage/
│   ├── __init__.py
│   ├── base.py           # 存储接口
│   ├── sqlite.py         # SQLite实现
│   └── redis.py          # Redis实现
├── events.py             # 事件系统
├── websocket.py          # WebSocket处理
├── checkpoint.py         # 检查点管理
├── queue.py              # 任务队列
├── estimator.py          # 时间估算
├── monitor.py            # 监控系统
└── api.py                # API接口
```

## 验收标准
1. 支持多任务并发执行和队列管理
2. 实时进度跟踪，1秒内更新延迟
3. 断点续传功能完整，支持任意阶段恢复
4. WebSocket实时通信稳定
5. 进度数据持久化可靠
6. 时间估算准确度在±20%范围内
7. 支持任务暂停/恢复/取消操作
8. 完整的监控和告警机制
9. CLI和API接口完整
10. 完整的单元测试和集成测试

## 预估工作量
**2-3 天**

## 风险点
1. 大量并发任务的性能影响
2. 断点续传的数据一致性
3. WebSocket连接的稳定性
4. 进度估算的准确性

## 后续任务依赖
- Task 006 (报告生成系统) - 需要进度状态信息用于报告元数据