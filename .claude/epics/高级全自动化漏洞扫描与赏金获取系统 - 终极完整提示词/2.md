---
name: 五阶段扫描实现
status: open
created: 2025-09-13T10:46:04Z
updated: 2025-09-13T10:46:04Z
github: [Will be updated when synced to GitHub]
depends_on: [003]
parallel: false
conflicts_with: []
---

# Task 004: 五阶段扫描实现

## 概述
实现完整的五阶段安全扫描系统，包括侦察、发现、扫描、验证和报告阶段。每个阶段都有明确的输入输出和状态管理。

## 技术要求

### 1. 阶段定义与架构
```python
class ScanPhase(Enum):
    RECONNAISSANCE = "reconnaissance"  # 侦察阶段
    DISCOVERY = "discovery"           # 发现阶段  
    SCANNING = "scanning"             # 扫描阶段
    VERIFICATION = "verification"     # 验证阶段
    REPORTING = "reporting"          # 报告阶段

class PhaseResult:
    phase: ScanPhase
    status: PhaseStatus
    start_time: datetime
    end_time: Optional[datetime]
    data: Dict[str, Any]
    errors: List[str]
    next_phase_inputs: Dict[str, Any]
```

### 2. 侦察阶段 (Reconnaissance)
- **目标**: 收集目标基础信息
- **输入**: 目标URL/域名
- **输出**: 子域名列表、IP范围、技术栈信息
- **工具集成**: subfinder, amass, httpx
- **实现模块**: `src/scanning/phases/reconnaissance.py`

```python
class ReconnaissancePhase:
    async def execute(self, target: str) -> PhaseResult:
        # 子域名枚举
        subdomains = await self.enumerate_subdomains(target)
        # IP范围收集
        ip_ranges = await self.collect_ip_ranges(subdomains)
        # 技术栈识别
        tech_stack = await self.identify_technologies(subdomains)
        # 社会工程学信息收集
        osint_data = await self.gather_osint(target)
```

### 3. 发现阶段 (Discovery)
- **目标**: 发现活跃服务和端口
- **输入**: IP列表、子域名列表
- **输出**: 活跃主机、开放端口、服务信息
- **工具集成**: nmap, masscan, nuclei
- **实现模块**: `src/scanning/phases/discovery.py`

```python
class DiscoveryPhase:
    async def execute(self, reconnaissance_data: Dict) -> PhaseResult:
        # 主机存活检测
        live_hosts = await self.check_host_alive(reconnaissance_data['ips'])
        # 端口扫描
        open_ports = await self.scan_ports(live_hosts)
        # 服务识别
        services = await self.identify_services(open_ports)
        # Web技术指纹识别
        fingerprints = await self.web_fingerprinting(reconnaissance_data['subdomains'])
```

### 4. 扫描阶段 (Scanning)
- **目标**: 深度漏洞扫描
- **输入**: 服务列表、技术栈信息
- **输出**: 潜在漏洞列表、风险评分
- **工具集成**: nuclei, custom scanners
- **实现模块**: `src/scanning/phases/scanning.py`

```python
class ScanningPhase:
    async def execute(self, discovery_data: Dict) -> PhaseResult:
        # 基于服务的漏洞扫描
        service_vulns = await self.scan_service_vulnerabilities(discovery_data['services'])
        # Web应用漏洞扫描
        web_vulns = await self.scan_web_vulnerabilities(discovery_data['web_services'])
        # 配置错误检测
        misconfigs = await self.detect_misconfigurations(discovery_data)
        # 敏感信息泄露检测
        sensitive_data = await self.detect_sensitive_exposure(discovery_data)
```

### 5. 验证阶段 (Verification)
- **目标**: 验证发现的漏洞
- **输入**: 漏洞列表
- **输出**: 已验证漏洞、PoC结果
- **实现模块**: `src/scanning/phases/verification.py`

```python
class VerificationPhase:
    async def execute(self, scanning_data: Dict) -> PhaseResult:
        # 漏洞验证
        verified_vulns = await self.verify_vulnerabilities(scanning_data['vulnerabilities'])
        # 误报过滤
        filtered_vulns = await self.filter_false_positives(verified_vulns)
        # 风险评估
        risk_assessment = await self.assess_risks(filtered_vulns)
        # 影响分析
        impact_analysis = await self.analyze_impact(filtered_vulns)
```

### 6. 报告阶段 (Reporting)
- **目标**: 生成结构化报告
- **输入**: 验证结果
- **输出**: 格式化报告、统计数据
- **实现模块**: `src/scanning/phases/reporting.py`

## 实现细节

### 阶段管理器
```python
class PhaseManager:
    def __init__(self):
        self.phases = {
            ScanPhase.RECONNAISSANCE: ReconnaissancePhase(),
            ScanPhase.DISCOVERY: DiscoveryPhase(),
            ScanPhase.SCANNING: ScanningPhase(),
            ScanPhase.VERIFICATION: VerificationPhase(),
            ScanPhase.REPORTING: ReportingPhase()
        }
    
    async def execute_phase(self, phase: ScanPhase, inputs: Dict) -> PhaseResult:
        phase_executor = self.phases[phase]
        return await phase_executor.execute(inputs)
    
    async def execute_all_phases(self, target: str) -> List[PhaseResult]:
        results = []
        current_inputs = {"target": target}
        
        for phase in ScanPhase:
            result = await self.execute_phase(phase, current_inputs)
            results.append(result)
            current_inputs = result.next_phase_inputs
            
        return results
```

### 错误处理与重试
- 阶段失败时的回滚机制
- 网络错误的自动重试
- 部分失败时的优雅降级
- 详细的错误日志记录

### 并发控制
- 阶段内任务的并发执行
- 资源限制和速率控制
- 目标服务器的保护机制

## 文件结构
```
src/scanning/phases/
├── __init__.py
├── base.py                 # 基础阶段类
├── reconnaissance.py       # 侦察阶段
├── discovery.py           # 发现阶段
├── scanning.py            # 扫描阶段
├── verification.py        # 验证阶段
├── reporting.py           # 报告阶段
└── manager.py             # 阶段管理器
```

## 验收标准
1. 所有五个阶段都能独立执行并返回结构化结果
2. 阶段间数据传递正确无误
3. 错误处理机制完善，不会因单点失败导致整个扫描中断
4. 支持阶段级别的暂停/恢复
5. 每个阶段都有详细的进度报告
6. 工具集成稳定，支持配置管理
7. 完整的单元测试覆盖
8. 性能满足要求（大规模目标扫描）

## 预估工作量
**2-3 天**

## 风险点
1. 第三方工具集成的稳定性
2. 大规模扫描的性能优化
3. 不同阶段间的数据一致性
4. 网络环境的适应性

## 后续任务依赖
- Task 005 (进度管理系统) - 需要阶段状态信息
- Task 006 (报告生成系统) - 需要扫描结果数据